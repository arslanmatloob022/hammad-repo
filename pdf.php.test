<?php
session_start();
require_once 'config.php';
require 'vendor/autoload.php'; // Ensure you have Guzzle installed via Composer

use GuzzleHttp\Client;

if (isset($_GET['id'])) {
    $eid = $_GET['id'];

    // Step 2: Decode the URL-encoded ID
    $decodedId = urldecode($eid);

    // Step 3: Decode the base64-encoded ID
    $base64DecodedId = base64_decode($decodedId);

    // Step 4: Sanitize the decoded ID to prevent SQL injection
    $id = mysqli_real_escape_string($conn, $base64DecodedId);

    // Check if the ID exists in the database
    $check = mysqli_query($conn, "SELECT * FROM form WHERE id='$id'");
    if (mysqli_num_rows($check) == 0) {
        echo "<script>
                window.location.href='list';
              </script>";
        exit;
    } else {
        $data = mysqli_fetch_assoc($check);

        // Prepare parameters for the QR code generation
        $params = array(
            "data" => "https://mfs-moh-gov-om.com/scan?id=" . $eid,
            "config" => array(
                "body" => "pointed-in",
                "eye" => "frame13",
                "eyeBall" => "ball14",
                "erf1" => array(
                    "color" => "#ef7992",
                    "type" => "frame13"
                ),
                "erf2" => array(
                    "color" => "#ef7992",
                    "type" => "frame13"
                ),
                "erf3" => array(
                    "color" => "#ef7992",
                    "type" => "frame13"
                ),
                "brf1" => array(
                    "color" => "#000000",
                    "type" => "ball14"
                ),
                "brf2" => array(
                    "color" => "#000000",
                    "type" => "ball14"
                ),
                "brf3" => array(
                    "color" => "#000000",
                    "type" => "ball14"
                ),
                "bodyColor" => "#000000",
                "bgColor" => "#FFFFFF",
                "eye1Color" => "#ef7992",
                "eye2Color" => "#ef7992",
                "eye3Color" => "#ef7992",
                "eyeBall1Color" => "#000000",
                "eyeBall2Color" => "#000000",
                "eyeBall3Color" => "#000000",
                "logo" => "https://mfs-moh-gov-om.com/logo2.png",
                "logoMode" => "default",
                "gradientColor1" => "#ef7992",
                "gradientColor2" => "#000000",
                "gradientType" => "linear",
                "gradientRotation" => 90,
                "gradientOnEyes" => false
            ),
            "size" => 100,
            "download" => false,
            "file" => "svg"
        );

        // Using Guzzle HTTP client
        $client = new \GuzzleHttp\Client();

        try {
            $response = $client->request('POST', 'https://qrcode-monkey.p.rapidapi.com/qr/custom', [
                'json' => $params,
                'headers' => [
                    'Content-Type' => 'application/json',
                    'x-rapidapi-host' => 'qrcode-monkey.p.rapidapi.com',
                    'x-rapidapi-key' => 'be858ad2c7msha8925bef79d04f1p18a776jsn58cc9efdf7d2',
                ],
            ]);

            // Save the SVG file
            $result = $response->getBody();
            file_put_contents('qr_code.svg', $result);

        } catch (\GuzzleHttp\Exception\RequestException $e) {
            echo 'Error: ' . $e->getMessage();
        }
    }

} else {
    echo "ID parameter is missing.";
    echo "<script>
            window.location.href='list';
          </script>";
    exit;
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
</head>
<style>
    * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
    }

    body {
        font-family: promo-regular !important;
    }

    @font-face {
        font-family: Blacker;
        src: url(assets/font/Blacker/Blacker-Text-Medium-trial.ttf);
    }

    .Zetafonts-font {
        font-family: Blacker !important;
    }

    @font-face {
        font-family: promo-medium;
        src: url(./assets/font/promo-font/PromoTest-Medium-BF63b78802b0fd1.otf);
    }

    .qr-code {
        position: relative;
        width: 145px;
        height: 145px;
        margin: 26px 0px 5px 0px;
    }

    .qr-code img {
        height: 100%;
        mix-blend-mode: screen;
    }

    .font-light {
        font-family: promo-light !important;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    .scan-me {
        font-size: 14px;
        margin: 0px;
    }

    .registration,
    .info,
    .status {
        border: 2px solid #5c5c5b;
        border-radius: 10px;
        padding: 5px 10px;
    }

    th, td {
        text-align: left;
    }

    th:first-child, th:nth-child(3) {
        width: 30%;
        font-weight: 600;
    }

    td {
        width: 43.5%;
        text-align: center;
        font-size: 12px;
        font-family: arial !important;
        padding-top: 9px;
    }

    th {
        padding-top: 8.5px;
        font-size: 13px;
    }

    .scan {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .scan {
        border: 2px solid #cc181c;
        border-radius: 10px;
        padding: 5px;
        margin-right: 10px;
        margin-left: -5px;
    }

    .box {
        background-color: aqua;
        height: 200px;
        width: 200px;
    }

    .name {
        font-size: 14px;
        text-align: center;
        margin: 0px 0px 35px 0px;
    }

    .fit {
        font-size: 16px;
        width: 90%;
        margin: 10px 0px 10px 0px;
        padding: 15px !important;
        border: 2px dashed #000000;
        color: #37b24d;
        text-align: center;
        border-radius: 10px;
        font-weight: bold;
    }

    .qr-con {
        margin-bottom: 20px;
    }

    .aprove-img {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .aprove-img img {
        width: 200px;
        margin: 20px;
        height: 200px;
    }

    .cus-size {
        font-size: 25px;
        text-align: center;
        color: #000000;
    }

    .cus-size1 {
        font-size: 20px;
        text-align: center;
        color: #000000;
        width:150%;
    }

    .custom-sz {
        font-size: 14px;
        text-align: center;
        color: #000000;
        font-family: promo-regular;
    }

    .medical-status {
        display: flex;
        justify-content: space-around;
        width: 100%;
    }

    .medical-status div {
        font-size: 13px;
        padding:0;
        color: #000000;
        margin: 0;
    }
</style>

<div class="center">
    <div class="py-md-5" id="download_section">
        <div class="row borders">
            <div class="col-3 width-29 p-0 d-flex align-items-start flex-column">
                <h5 class="custom-sz med-mar-top"><strong>Sultanate Of Oman</strong></h5>
                <h5 class="custom-sz"><strong>Ministry Of Health</strong></h5>
            </div>
            <div class="col-6 width-46">
                <div class="logo d-flex align-items-center justify-content-center flex-column">
                    <img src="assets/images/logo.png" height="80" alt="Logo">
                    <h1 class="cus-size arabic mb-2">شهادة الفحص الطبي للوافدين</h1>
                    <h1 class="cus-size1 Zetafonts-font m-0">Expatriates Medical Exam Certificate</h1>
                </div>
            </div>
            <div class="col-3 width-29"></div>
        </div>
        <div class="qr-con">
            <div class="scan">
                <div class="qr-code">
                    <img src="qr_code.svg" alt="QR Code">
                </div>
                <h4 class="name">Scan Me</h4>
                <div class="registration">
                    <p class="text-center">Application Number: <?php echo $data['id']; ?></p>
                    <p class="text-center">Status: Approved</p>
                </div>
            </div>
        </div>
        <div class="medical-status">
            <div class="application">
                <h6 class="cus-size">Application Type</h6>
                <p class="custom-sz"><?php echo $data['application_type']; ?></p>
            </div>
            <div class="status">
                <h6 class="cus-size">Status</h6>
                <p class="custom-sz"><?php echo $data['status']; ?></p>
            </div>
        </div>
    </div>
</div>

<script src="assets/js/bootstrap.min.js"></script>
</html>
